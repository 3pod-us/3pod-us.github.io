<?php 
$files = Database::GetData("categories");
$files = pencil::sorting($files, [
	"sortby" => "asc",
	"dataType" => "FILES",
	"itemName" => FALSE
]);
$data = pencil::openFiles($files);
$data = pencil::selectData($data, [
	"__id__",
	"name_category",
	"subcategories",
	"position"
]);

$data = pencil::sorting($data, [
	"dataType" => "ARRAY",
	"sortby" => "asc",
	"itemName" => "position"
]);

?>
<script>
	var listCategories = <?= json_encode( $data, TRUE ) ?>;
</script>

<style>
.modal__container{
	min-width: 600px;
}
</style>
<section class="columns is-multiline">
	<div class="col_12 has-text-centered">
		<h1 class="title bold">
			<br>
			Manage categories for requests <br>
			<span class="is-size-5 lighter">
				Pencil's Service Categories
			</span>
		</h1>
	</div>
	<div class="column offset-1 offset-1-r">
		<button onclick="tableList.show('modal-creator-category')" class="button is-medium is-info has-text-primary bold is-rounded">
			New Category
		</button>		
		<table class="responsive-table table" id="table-list" style="font-size: 92%;">
		  <caption>Table List</caption>
		  <thead>
		    <tr>
		      <th scope="col">Category Name</th>
		      <th scope="col">Sub-Categories N°</th>
		      <th scope="col">Actions</th>
		    </tr>
		  </thead>
		  <tbody id="rows-of-categories">
			<!-- will appear with javascript -->
		  </tbody>
		</table>
		<div class="box rounded-message col_12" style="margin-top: 50px;display: none;" id="container-onShow">
			<!-- will appear with javascript -->
		</div>
		<div id="modals-table-categories-created">
			<!-- will appear with javascript -->
		</div>
	</div>
</section>



<style>
	.modal__container{
		max-width: 900px;
		min-width: 320px;
		width: 100%;
	}
	.sub-category-containers{
		margin-top: 12px;
	}
	.global-container-styles{
		margin-top: 0px !important;
	}
	.sub-category-containers .field{
		margin-bottom: 0px !important; 
	}
	.styles-subcategory-containers{
		margin-top: 6px;
	}
</style>
<div id="container-modal-creator-category">
	<!--  MODAL CREATOR FOR CATEGORIES -->
</div>
<script>
function reload(){
	setTimeout(function(){
		window.location.href = "";
	}, 500)
}
/*
 * 
 * 
 * This is for create and update categories.
 * Update - Create
 * 
 * 
*/
var category = {
	PreviewImage: function(target, URL){
		target = turpial.find(target);
		target.src = URL;
	},
	removeFromDB: {
		init: (_id_)=>{
			var html = `
				Are you sure?
				<a data-spop="close" class="button is-small is-dark" onclick="category.removeFromDB.finalize('${_id_}')">YES</a> 
				<a data-spop="close" class="button is-small is-light">NO</a>			
			`;
			spop({
			  template: html,
			  style: "error",
			  position  : "bottom-right"
			});
		},
		finalize: (_id_)=>{
			pencil.database.push({
				data: {
					info: {},
					_id_: _id_,
					eliminate: "<?= md5("eliminate_category") ?>",
					"setNewCategory": true
				},
				ready: function( response ){
					if(response === "all-is-fine"){
						toast("Succesfully Completed.", "success");
						reload();					
					}else{
						toast("there's a critical error. 995.", "error");
					}
				}
			})
		}
		
	},
	onsent: function( formHTML, _id_ ){
		if(_id_ === "false"){
			_id_ = false;
		}
		var button = formHTML.querySelector(".button-edit-create");
		button.setAttribute("disabled", "");

		var formData = {
			category: formHTML.querySelector(".name-category").value,
			position: formHTML.querySelector(".position-category").value,
			subcategories: [], // will be filled below
		};

		var target = formHTML.querySelector(".subcategories");
		var els = [...target.querySelectorAll(".sub-category-containers")];
		
		els.forEach(function( el ){				
			var inputs = [...el.querySelectorAll("input")];
			var subcategory = {
				name: inputs[0].value,
				img: inputs[1].value,
				styles: []
			}

			var containerStyles = el.querySelector(".global-container-styles");
			containerStyles = [...el.querySelectorAll(".styles-subcategory-containers")];
			// Custom Idea (11.25"x11.25") Goods
			containerStyles.forEach(function( style ){
				var inputs = [...style.querySelectorAll("input")];
				var settingStyle = {
					name: inputs[0].value,
					img: inputs[1].value
				}
				subcategory.styles.push( settingStyle );
			});
			formData.subcategories.push( subcategory );
		});
		pencil.database.push({
			data: {
				info: formData,
				_id_: _id_,
				"setNewCategory": true
			},
			ready: function( response ){
				if(response === "all-is-fine"){
					toast("Succesfully Completed.", "success");
					reload();						
				}else{
					toast("there's a critical error. 995.", "error");
				}
				button.removeAttribute("disabled");
			}
		})
	},
	numberForSub: 0,
	numberForStyle: 0,
	removeInputStyle: function(input){
		// this will control that not every style of being removed.
		// the app need at least one style for each sub-category.
		// let's:
		input = turpial.find(input);
		var length = input.parentNode.childElementCount;
		if(length === 1){
			toast("You need at least one style for a sub-category", "warning");
			return;
		}
		input.remove();
	},
	remove: function(el){	
		// this will remove an entire element with a filter.
		var html = `
			Are you sure?
			<a data-spop="close" class="button is-small is-dark" onclick="turpial.find('${el}').remove();toast('Removed!', 'success');">YES</a> 
			<a data-spop="close" class="button is-small is-light">NO</a>			
		`;
		spop({
		  template: html,
		  style: "error",
		  position  : "bottom-right"
		});
	},
	confirmRemoveStyle: function(button){
		pencil.confirm.action("Do you want to remove this Style?", {
			onConfirm: function(){
				category.removeInputStyle(button.parentNode.parentNode.parentNode)
				toast("Succesfully removed!", "success");
			}
		});


	},
	inputStyle: function(number, props){
		props = turpial.un(props, {});
		return `
		<div class="column is-4">
			<div id="style-container--${number}" class=" styles-subcategory-containers box">
				<a onclick="category.confirmRemoveStyle(this)" class="delete has-background-danger float-r" onclick="category.remove('sub-category-container--${this.numberForSub}')"></a><br />
				<p class="control helper-textarea-for-inputs">
					<textarea class="textAreaHelper is-hidden">${turpial.un(props.name, "")}</textarea>	
					<input class="styles-subcategories input is-small is-static" id="styles-subcategory--${number}" type="text" placeholder="name" required/>
				</p>
				<img style="width:100%;" id="show--image-style-${this.numberForSub}" src="${turpial.un(props.img, "")}" alt=" " />
				<input onchange="category.PreviewImage('show--image-style-${this.numberForSub}', this.value)" value="${turpial.un(props.img, "")}" class="styles-subcategories-photos input is-small is-static is-fullwidth" id="styles-subcategories-photo--${number}" type="url" placeholder="image url" required/>
			</div>
		</div>`;
	},
	inputSubCategory: function(sub_edit){
		var app = this;
		sub_edit = turpial.un(sub_edit, []);

		// on edit existence styles of subs!
		var styles = {
			set: ()=>{
				if(sub_edit.length === 0){
					// si no se esta en ambito de edición
					return category.inputStyle(this.numberForSub);
				}
				// si no: construir!

				var subsStylesToEdit = "";
				sub_edit.styles.forEach(( sub )=>{
					subsStylesToEdit += app.inputStyle(app.numberForSub, {
						name: sub.name,
						img: sub.img
					});
				})
				return subsStylesToEdit; // execute below!
			}
		}

		return `<div id="sub-category-container--${this.numberForSub}" class="field is-grouped is-grouped-multiline sub-category-containers">
				<hr class="col_12" />
				<div class="col_12">
					<h2 id="subcategory-title--${this.numberForSub}" class="subtitle bold is-size-3 has-text-info has-text-centered is-marginless">${turpial.un(sub_edit.name, "Sub Category Name")}</h2>
				</div>
				<div class="col_12"></div>
				<div class="columns is-multiline col_12">
					<div class="column is-4">
						<div class="box">
							<a class="delete has-background-danger float-r" onclick="category.remove('sub-category-container--${this.numberForSub}')"></a><br />
							<p class="control helper-textarea-for-inputs">
								<textarea class="is-hidden textAreaHelper">${turpial.un(sub_edit.name, "")}</textarea>				
								<input onkeyup="turpial.insert('subcategory-title--${this.numberForSub}', this.value)" class="sub-categories input is-static" id="subcategory--${this.numberForSub}" type="text" placeholder="name" required/>
							</p>
							<img style="width:100%;" id="show--image-subcategory-${this.numberForSub}" src="${turpial.un(sub_edit.img, "")}" alt=" " />	
							<strong>Image</strong>			
							<input onchange="category.PreviewImage('show--image-subcategory-${this.numberForSub}', this.value)" value="${turpial.un(sub_edit.img, "")}" class="sub-categories input is-static is-fullwidth" id="subcategoryPhoto--${this.numberForSub}" type="url" placeholder="IMAGE URL" required/>
							<a onclick="turpial.mount('subcategory-style--${this.numberForSub}', category.inputStyle(${this.numberForSub}) )" class="button is-fullwidth is-primary has-text-info is-rounded bold">
								Add Style
							</a>
						</div>						
					</div>
					<div class="column is-8 global-container-styles" id="subcategory-style--${this.numberForSub}">
						<div class="columns is-multiline">
							${styles.set()}
							<span data-sum="${this.numberForSub++}"></span>
						</div>
					</div>
				</div>				
			</div>
		`
	},
	creator: function( data ){
		var app = this;
		data.insert = turpial.un(data.insert, "default");
		/* CREATE MODALS TO EDIT */
		if(turpial.un(data.modal_edit, false) === true){
			var subs = "";
			var inputsSubsToEdit = "";
			data.subs.forEach(( sub )=>{
				inputsSubsToEdit += app.inputSubCategory(sub)
			})
		}
		var html = modaltmpl({
			id: data.id,
			closeOnClickOverlay: false,
			title: data.title,
			content: `
				<div class="col_12" id="category-creator-${data.id}">
					<button onclick="tableList.back();" class="button is-primary has-text-info is-rounded bold">
						Back to category list
					</button>
					<br /><br />
					<form onsubmit="event.preventDefault();category.onsent(this, '${turpial.un(data._id_, false)}');" method="POST" action="">
						<div class="field">
							<div>
								<label class="label">Category Name</label>
								<div class="field has-addons">
									<div class="control is-expanded">
										<input value="${turpial.un(data.name, "")}" class="input is-fullwidth is-hovered name-category" placeholder="Category Name" type="text" required/>
									</div>
									<div class="control is-expanded">
										<input value="${turpial.un(data.position, "")}" class="input is-hovered position-category" min="1" max="150" placeholder="Dropdown Position" type="number" required/>
									</div>
								</div>
								
															
								<div class="field subcategories" id="subcategories-${data.id}">
									${turpial.un(inputsSubsToEdit, "")}
								</div>
								<hr />
								<a onclick="turpial.mount('subcategories-${data.id}', category.inputSubCategory());" class="button bold is-rounded is-primary has-text-info">
										ADD NEW SUB CATEGORY
								</a>
								<hr />
								
								<div class="columns is-multiline" id="container--styles-">
									<div class="column offset-3 offset-3-r is-6">
										<button style="margin-top:20px;" class="button is-info is-rounded bold has-text-primary is-fullwidth button-edit-create">
											SUBMIT
										</button>
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
			`
		})
		if(data.insert === "default"){
			turpial.insert(data.target, html);
			return;
		}
		return html;
	}
}
var defaultCreator = function(){
	category.creator({
		target: "container-modal-creator-category", 
		id: "modal-creator-category",
		title: "Create a new category->subcategory->style"		
	});
}
defaultCreator();
</script>



<script>
/*
 * 
 * 
 * This is for edit the categories
 * it will use the code above.
 * 
 * 
*/

tableList = {
	show: function(target){
		target = turpial.find( target );
		target = target.querySelector(".modal__content div");
		var container = turpial.find("container-onShow");
		var listElements = turpial.find("table-list");		
		container.innerHTML = target.outerHTML;
		listElements.style.display = "none";
		container.style.display = "block";
	},
	back: function(){
		var container = turpial.find("container-onShow");
		var listElements = turpial.find("table-list");
		listElements.style.display = "table";
		container.style.display = "none";
		container.innerHTML = "";
	},
	template: function(category, number){
		category.subcategories = pencil.json.parse(category.subcategories)
		var length = category.subcategories.length;
		return `
		<tr>
	      <td data-label="Category Name"><strong>${category.position})</strong> ${category.name_category}</td>
	      <td data-label="Sub-Categories N°">${length}</td>
	      <td data-label="Actions">
			<div class="columns is-multiline is-mobile">
				<div class="column">
					<a onclick="tableList.show('${"modal-row-category-"+number}')" class="button is-small is-info is-rounded has-text-primary bold">
						EDIT
					</a>
				</div>
				<div class="column">
					<a onclick="category.removeFromDB.init('${category.__id__}')" class="button is-small is-danger bold is-rounded">
						REMOVE
					</a>
				</div>
			</div>
	      </td>
	    </tr>
	`
	},
	push: function(){
		var app = this;
		var html = "";
		var modals = "";
		listCategories.forEach(function( row, number ){
			html  += app.template( row, number );
			modals += category.creator({
				id: "modal-row-category-"+number,
				insert: false,
				_id_: row.__id__,
				name: row.name_category,
				position: turpial.un(row.position, '0'),
				subs: row.subcategories,
				modal_edit: true
			});
		})
		turpial.insert("rows-of-categories", html);
		turpial.insert("modals-table-categories-created", modals)
	}
	}
tableList.push();
</script>
<script>
// helper for inputs
// with errors on "" or '' signs.
var containers = document.querySelectorAll(".helper-textarea-for-inputs");
[...containers].forEach(function(cont){
	var textarea = turpial.map(cont, [0]);
	var input = turpial.map(cont, [1]);
	input.setAttribute("value", textarea.value)
})
</script>
